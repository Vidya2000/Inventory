<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="bg-light">
<div class="container py-4">
<h2 class="mb-4 text-center animate__animated animate__fadeInDown">üõ†Ô∏è Admin Dashboard</h2>

<div class="mb-3 text-center">
    <a href="{{ url_for('home') }}" class="btn btn-secondary btn-sm">Home</a>
    <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">Logout</a>
    <a href="{{ url_for('export_csv') }}" class="btn btn-success btn-sm animate__animated animate__pulse animate__infinite">Download CSV</a>
    <form action="{{ url_for('import_csv_route') }}" method="post" enctype="multipart/form-data" class="d-inline-block ms-2">
        <input type="file" name="file" accept=".csv" class="form-control form-control-sm d-inline-block w-auto" required>
        <button type="submit" class="btn btn-info btn-sm">Import CSV</button>
    </form>
</div>

<div class="card p-3 mb-4 animate__animated animate__fadeIn">
    <h4>Add Product</h4>
    <form action="{{ url_for('add') }}" method="post" class="d-flex flex-wrap gap-2">
        <input type="text" name="id" placeholder="Product ID" class="form-control w-auto" required>
        <input type="text" name="name" placeholder="Product Name" class="form-control w-auto" required>
        <input type="number" name="price" step="0.01" placeholder="Price" class="form-control w-auto" required>
        <input type="number" name="stock" step="1" placeholder="Stock" class="form-control w-auto" required>
        <button type="submit" class="btn btn-primary">Add</button>
    </form>
</div>

<div class="card p-3 mb-4 animate__animated animate__fadeIn">
    <h4>Search Product</h4>
    <input type="text" id="searchBox" placeholder="Type Product ID or Name" class="form-control w-auto mb-2">
    <div id="searchResults"></div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="animate__animated animate__fadeIn">
    {% for category, msg in messages %}
      <div class="alert alert-{{ 'success' if category=='success' else 'danger' if category=='danger' else 'info' }} alert-dismissible fade show mt-2" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
    </div>
  {% endif %}
{% endwith %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
const searchBox = document.getElementById("searchBox");
const resultsDiv = document.getElementById("searchResults");

searchBox.addEventListener("input", function() {
    const query = this.value;
    if(query.length === 0){
        resultsDiv.innerHTML = "";
        return;
    }

    fetch(`/search_products?q=${query}`)
        .then(response => response.json())
        .then(data => {
            const products = data.products;
            if(products.length === 0){
                resultsDiv.innerHTML = "<p>No matching products</p>";
                return;
            }

            let table = `<table class="table table-bordered"><thead>
                         <tr><th>ID</th><th>Name</th><th>Price</th><th>Stock</th>
                         <th>Actions</th></tr></thead><tbody>`;
            products.forEach(p => {
                const lowStockClass = p.stock < {{ LOW_STOCK_THRESHOLD }} ? "table-danger" : "";
                table += `<tr class="${lowStockClass}">
                            <td>${p.id}</td>
                            <td>${p.name}</td>
                            <td>${p.price}</td>
                            <td>${p.stock}</td>
                            <td>
                                <a href="/update/${p.id}" class="btn btn-warning btn-sm">Update</a>
                                <a href="/delete/${p.id}" class="btn btn-danger btn-sm">Delete</a>
                            </td>
                          </tr>`;
            });
            table += "</tbody></table>";
            resultsDiv.innerHTML = table;
        });
});
</script>
</body>
</html>
